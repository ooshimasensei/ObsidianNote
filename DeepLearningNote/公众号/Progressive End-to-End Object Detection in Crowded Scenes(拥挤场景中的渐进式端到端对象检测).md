# 导语
该文中提出了一种新的基于query的人群检测框架。以往的基于query的检测器存在两个缺点：在拥挤场景中通常会给单个对象进行多个预测；随着解码阶段深度的增加，性能会呈现饱和。受到一对一标签分配规则的性质的启发，作者提出了一种渐进式的预测方法来解决上述问题。作者选择易于生成真正正预测的可接受查询，然后根据先前接受的预测结果来优化其余的嘈杂查询。实验证明，文中的方法可以显著提高拥挤场景中基于query的检测器的性能，同时对于拥挤情况具有鲁棒性，仍然可以在中度和轻度拥挤的数据集上有良好的表现。
# 文献背景
拥挤目标检测是计算机视觉领域中一个实际并且有挑战性的研究领域。在过去几十年中，已经进行了许多研究工作并取得了卓越的进展。但是，大多数方法需要手工设置组件，如锚点设置和后处理，导致在处理场景时性能不佳。受DETR启发，作者研究在拥挤场景中的使用query的目标检测方法，旨在设计更复杂的端到端检测框架。尽管这些方法在像COCO这样的轻度拥挤数据集上可以获得显著的结果，但作者的初步研究表明，它们在拥挤场景中面临一些问题：使用query的检测器倾向于为单个对象推断多个预测，引入了假阳性。随着解码阶段深度的增加，检测器的性能会饱甚至恶化。

作者提出了一种渐进式预测方法来提高基于query的目标检测器在处理拥挤场景中的性能。首先设计一个预测选择器，用于选择与高置信度分数相关联的查询作为接受的查询，将其余的查询视为嘈杂的查询。然后，为了让嘈杂的查询"感知"到它们的目标是否已被检测到。设计了一个关系提取器，用于建模嘈杂查询和它们的接受邻居之间的关系。此外，通过仅对空间相关的邻居执行新的本地自注意机制，作者开发了一个查询更新器。最后，引入了一个新的一对一标签分配规则，逐步分配已接受和经过优化的嘈杂查询中的样本。

文中的方法可以集成到多种架构中，可以显著提高基于query的检测器的性能。引入文中方法的具有ResNet-50骨干的Sparse RCNN在具有挑战性的数据集CrowdHuman上取得了92.0%的AP，41.4%的MR−2和83.2%的JI，优于基于框的方法MIP。此外，引入作者方法的D-DETR 也取得了92.1%的AP和84.0%的JI,作者的方法对于拥挤程度较低的场景也能够表现得相当不错。
# 研究方法

作者提出的渐进式预测方法包括多个组件：预测选择器、关系信息提取器、查询更新器和标签分配，结构如图1所示。
![[Pasted image 20231106110342.png]]

**预测选择器。** 作者设计了一个预测选择器，用于选择那些倾向于生成高置信度预测的查询作为接受的查询，同时将其余的查询视为需要进一步优化的嘈杂查询。这个过程可以表示为。
![[Pasted image 20231106105639.png]]
其中，t是阶段编号。Dt−1表示前一个t − 1阶段中由所有查询生成的所有预测。Dh t−1和Dl t−1表示从接受的查询和嘈杂的查询生成的接受的预测和嘈杂的预测，分别。bi和si分别表示预测的框和其置信度分数。s是置信度分数阈值。

**关系信息提取器。** 接受的查询可以准确预测大部分目标对象。因此，如果一个对象已被一个接受的预测检测到，就没有必要再次使用嘈杂的预测来检测它。为了使这些嘈杂的查询具备感知其目标是否已被检测的能力，作者开发了一个关系信息提取器来建模嘈杂的预测和它们的接受邻居之间的关系。关系信息提取器的详细设计如图5所示
![[Pasted image 20231106110745.png]]

对于每个嘈杂的预测bi，作者首先在Dh t−1中找到它们的接受邻居N (bi)，构建空间相关的对(bi, N (bi))。然后，编码的对以及它们之间的交并比（IoU）被馈送到紧凑型网络中，以获得几何关系特征H(bi)。由于与每个嘈杂的预测对应的接受邻居数量是不确定的，作者使用聚合函数将H(bi)减少到相同的特征维度，同时保持置换不变性特性。在作者的方法中，默认使用最大池化。此外，与变换后的查询特征融合的池化几何特征，还通过非线性函数进行激活。U(·, ·)由两个连续的带有ReLU [31]激活函数的全连接层组成，以增加非线性性。请注意，F(·)和U(·)共享相同的架构，但是它们是独立的权重。在这里，qi的梯度被阻止从后向传播到以前的阶段。
![[Pasted image 20231106110719.png]]
这里，N (·)代表一个函数，根据IoU（交并比）和阈值θ来为盒子bi找到邻居。在这里，作者使用它来找到Dl t−1中嘈杂预测的Dh t−1中的接受邻居。E(·, ·)是正弦和余弦的空间位置编码函数。另外，U(·, ·)表示用于从编码输入生成几何关系特征H(bi)的函数。嘈杂查询qi对应于Dl t−1中的嘈杂预测bi，通过函数F (·)进行变换。池化的几何特征和变换后的查询特征F(qi)通过逐元素求和进行融合，然后通过函数T生成所需的关系特征R(bi)。


**查询更新器。** 为了进一步优化嘈杂查询的特征，作者开发了一个查询更新器。由于Dl t−1和Dh t−1的数据分布与Dt−1的不同，首先引入一组新的可学习查询来通过逐元素求和来补充关系特征。然后，作为输入查询qt−1，采取了一组补充的嘈杂查询，以执行新的本地自注意机制LMSAt−1和随后的动态卷积。
![[Pasted image 20231106110845.png]]
由于目标检测主要关注图像中的局部区域，因此作者设计了一个新的本地自注意模块LMSAt，用于更新嘈杂查询qt−1。它确保每个查询仅与局部邻居进行交互，而不是与整个图像上的所有查询。本地自注意首先根据IoU值大于0的边界框来找到每个查询的邻居。然后，它执行与MSA相同的“qkv”机制。因此，作者在本地执行自注意，而不是全局执行。
与中的邻居查找规则不同，作者采用函数N(·)来选择Dt−1中与qt−1在IoU方面具有空间关联的邻居。请注意，新的本地自注意LMSAt−1用于替代方程(1)中的MSAt−1，以进行特征交互。

**标签分配** 由于接受的查询倾向于生成真正的正预测，而嘈杂的查询涉及大量真正的正预测和假正预测。为了实现端到端的目标检测，作者引入了一种新的一对一标签分配规则，逐步分配样本。首先将接受的预测Dh t−1与目标对象的真实集合进行匹配。然后移除那些已经匹配的目标，主要考虑嘈杂预测Dl t−1与剩余目标对象的二分匹配。
# 实验验证
如表1所示，作者的方法在处理拥挤场景中相较于基于anchor、基于点和基于query的方法，取得了显著的性能提升，显示了作者的方法在处理拥挤场景中的有效性。
![[Pasted image 20231106153925.png]]
基于query的Sparse RCNN结合了作者提出的方法，在500个查询时，CrowdHuman数据集上可以取得92.0%的AP，41.4%的MR−2和83.2%的JI，比原始的Sparse RCNN 要好1.3%、3.3%和1.8%。当将查询数量增加到750个时，作者的方法仍然可以获得更好的性能，即92.5%的AP和83.3%的JI。这是因为更多的查询可以覆盖图像中物体的更多模式，例如尺度、大小、位置和其他特征。此外，配备作者的方法，D-DETR也可以在原始的D-DETR上实现2.2%的MR−2提升。此外，它还比基于框的方法MIP取得了1.4%的AP和1.6%的JI提升，展示了作者方法的有效性。

![[Pasted image 20231106154557.png]]
表2显示，关系信息提取器R可以取得0.8%的AP，1.7%的MR−2和1.6%的JI改进。这表明它在减少假阳性和提高假阴性召回方面的有效性。此外，当配备了新的本地自注意LMSA后，三个评估指标的性能进一步提升，因为本地自注意可以有效减少重复。另外，旨在近似噪音预测的新数据分布的新初始化嵌入，可以轻微提高MR−2。

如表3所示，与其他关系建模工作相比，作者的方法表现更好。RelationNet和GossipNet 在AP和MR−2方面都出现了显著下降。作者将其归因于次优的标签分配规则。它们都选择围绕一个目标的最高置信度分数的预测作为正确的框，并将其余的作为负例，预测的坐标没有参与计算损失，这可能导致在拥挤场景中性能下降。
# 总结
在这篇文章中，作者提出了一种渐进式预测方法，以提高基于query的目标检测器在处理拥挤场景中的性能。配备了作者的方法，两种代表性的基于query的方法，Sparse RCNN 和D-DETR ，在高度、中度和轻度拥挤的数据集上都取得了一致的改进，这表明作者的方法对于拥挤场景具有鲁棒性。由于Sparse RCNN和D-DETR需要大量的计算资源，使得作者的方法难以部署在计算能力有限的设备上。如何开发一个计算有效的端到端检测器仍在探讨中。此外，作者发现嘈杂的查询的决策边界不清晰。作者认为，如果采用更好的特征工程方法或损失函数，性能可以进一步提高。